<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö°Ô∏è –ê–í–¢–û–ù–û–ú–ù–ò–ô JSON –†–µ–¥–∞–∫—Ç–æ—Ä –∑ –ö–∞—Ä—Ç–æ—é (KharkivAlerts)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .controls, .map-section, .output {
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            height: fit-content;
        }
        .controls { flex: 1; min-width: 300px; max-width: 400px; }
        .map-section { flex: 2; min-width: 450px; }
        .output { flex-basis: 100%; margin-top: 20px; }
        h1 { color: #f39c12; margin-bottom: 20px; }
        h2 { color: #3498db; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #3498db; padding-bottom: 5px; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #2c3e50;
            border-radius: 4px;
            background: #2c3e50;
            color: #ecf0f1;
            box-sizing: border-box;
            font-size: 1em;
        }
        textarea#outputJson { 
            height: 250px; 
            resize: vertical; 
            font-family: monospace;
        }
        .btn-group { margin-top: 25px; display: flex; gap: 10px; }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background 0.3s;
        }
        .btn-add { background: #e74c3c; color: white; flex-grow: 1; }
        .btn-add:hover { background: #c0392b; }
        .btn-save { background: #2ecc71; color: white; flex-grow: 1; }
        .btn-save:hover { background: #27ae60; }
        .btn-load { background: #3498db; color: white; }
        .btn-load:hover { background: #2980b9; }
        .success-message { color: #2ecc71; font-weight: bold; margin-top: 10px; }

        #map { height: 600px; border-radius: 8px; }
        #activeAlertsList { max-height: 200px; overflow-y: auto; background: #2c3e50; padding: 10px; border-radius: 4px; margin-top: 10px; }
        .marker-popup { color: #000; }
        .alert-item-line { background: #2c3e50; padding: 5px; border-radius: 4px; margin-bottom: 5px; border-left: 5px solid; }
        .alert-item-line button { background: none; border: none; color: white; cursor: pointer; float: right; font-weight: bold; }
    </style>
</head>
<body>

    <div class="controls">
        <h1>üö® –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–∞–≥—Ä–æ–∑–∏</h1>
        
        <label for="inputType">–¢–∏–ø –∑–∞–≥—Ä–æ–∑–∏:</label>
        <select id="inputType">
            <option value="s300">üî¥ –°-300 / –°-400 (–ë–∞–ª—ñ—Å—Ç–∏–∫–∞)</option>
            <option value="shahed">üõ∏ –î—Ä–æ–Ω Shahed</option>
            <option value="kab">üí£ –ö–ê–ë / –£–ú–ü–ë</option>
            <option value="iskander">üí• –Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú</option>
            <option value="fpv">üõ∞Ô∏è FPV-–¥—Ä–æ–Ω / –†–æ–∑–≤—ñ–¥–∫–∞</option>
            <option value="artillery">üî• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è / –†–°–ó–í</option>
            <option value="alert">‚ö†Ô∏è –ó–∞–≥–∞–ª—å–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞</option>
        </select>
        
        <label for="inputLocation">–õ–æ–∫–∞—Ü—ñ—è:</label>
        <input type="text" id="inputLocation" value="–•–∞—Ä–∫—ñ–≤" required>
        
        <label for="inputCoords">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (lat, lon) <span style="color:#2ecc71;">(–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ!)</span>:</label>
        <input type="text" id="inputCoords" value="49.9935, 36.2304" required>
        
        <label for="inputMessage">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:</label>
        <textarea id="inputMessage" rows="2" required>–í–∏—Å–æ–∫–∞ –∑–∞–≥—Ä–æ–∑–∞. –ó–∞–ª–∏—à–∞–π—Ç–µ—Å—å –≤ —É–∫—Ä–∏—Ç—Ç—ñ!</textarea>
        
        <label for="inputDirection">–ú–∞—Ä—à—Ä—É—Ç Shahed (–ü—Ä–∏–∫–ª–∞–¥: [50.11, 36.12], [50.05, 36.15]...)</label>
        <textarea id="inputDirection" rows="2" placeholder="–î–æ–¥–∞–π—Ç–µ –º–∞—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ª—ñ–Ω—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è Shahed)"></textarea>

        <div class="btn-group">
            <button class="btn btn-add" onclick="generateNewAlert()">‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–≥—Ä–æ–∑—É –≤ —Å–ø–∏—Å–æ–∫</button>
            <button class="btn btn-add" style="background: #e67e22;" onclick="clearAlerts()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
        </div>
        
        <div style="margin-top: 20px;">
            <h2>üõ†Ô∏è –ê–∫—Ç–∏–≤–Ω—ñ –∑–∞–≥—Ä–æ–∑–∏:</h2>
            <div id="activeAlertsList">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞–≥—Ä–æ–∑.</div>
        </div>
    </div>

    <div class="map-section">
        <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –¥–ª—è –≤–∏–±–æ—Ä—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</h2>
        <div id="map"></div>
    </div>

    <div class="output">
        <h1>üíæ –ê–≤—Ç–æ–Ω–æ–º–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON</h1>
        <p>
            **1. –í—Å—Ç–∞–≤—Ç–µ** –≤–∞—à –ø–æ—Ç–æ—á–Ω–∏–π JSON (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ).<br>
            **2. –ó–º—ñ–Ω—ñ—Ç—å** —Å–ø–∏—Å–æ–∫ –∑–∞–≥—Ä–æ–∑.<br>
            **3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ê–≤—Ç–æ–Ω–æ–º–Ω–æ –∑–±–µ—Ä–µ–≥—Ç–∏"** –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ–∞–π–ª—É <code>alerts.json</code> –Ω–∞ –≤–∞—à–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ Node.js.
        </p>
        
        <textarea id="outputJson"></textarea>
        
        <div class="btn-group">
            <button class="btn btn-load" onclick="loadJson()">‚¨ÜÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ JSON —É –†–µ–¥–∞–∫—Ç–æ—Ä</button>
            <button class="btn btn-save" onclick="saveJsonRemotely()">üíæ –ê–≤—Ç–æ–Ω–æ–º–Ω–æ –∑–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
        <div id="copySuccess" class="success-message" style="display: none;"></div>
    </div>

    <script>
        let activeAlerts = []; 
        let map;
        let markersLayer = new L.LayerGroup();
        let directionLinesLayer = new L.LayerGroup();
        let currentMarker = null; 
        
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–†–í–ï–†–ê ---
        // !!! –≠–¢–û –î–û–õ–ñ–ù–û –°–û–í–ü–ê–î–ê–¢–¨ –° –ê–î–†–ï–°–û–ú –í–ê–®–ï–ì–û –ó–ê–ü–£–©–ï–ù–ù–û–ì–û NODE.JS –°–ï–†–í–ï–†–ê !!!
        const SERVER_URL = 'http://localhost:3000/api/save-alerts'; 

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ---
        function initMap() {
            if (map) return;
            
            const initialCoords = [49.9935, 36.2304]; // –¶–µ–Ω—Ç—Ä –•–∞—Ä—å–∫–æ–≤–∞
            
            map = L.map('map').setView(initialCoords, 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(map);

            markersLayer.addTo(map);
            directionLinesLayer.addTo(map);
            
            // –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(5);
                const lon = e.latlng.lng.toFixed(5);
                document.getElementById('inputCoords').value = `${lat}, ${lon}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                currentMarker = L.marker(e.latlng).addTo(map);
            });
        }

        // --- –ì–õ–ê–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

        function updateMapDisplay() {
            markersLayer.clearLayers();
            directionLinesLayer.clearLayers();
            activeAlerts.forEach(alert => {
                const coords = alert.coords;
                const type = alert.type;
                
                const iconHtml = `<div style="background-color: ${getAlertColor(type)}; width: 15px; height: 15px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px ${getAlertColor(type)};"></div>`;
                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-div-icon',
                    iconSize: [15, 15],
                    iconAnchor: [7, 7]
                });

                const marker = L.marker(coords, { icon: customIcon });
                marker.bindPopup(`
                    <div class="marker-popup">
                        <strong>${getTypeName(type)}</strong><br>
                        ${alert.location.replace(/_/g, ' ')}
                    </div>
                `).openPopup();
                markersLayer.addLayer(marker);
                
                if (type === 'shahed' && alert.direction_line && Array.isArray(alert.direction_line)) {
                    const line = L.polyline(alert.direction_line, {
                        color: getAlertColor(type),
                        weight: 3,
                        dashArray: '10, 5'
                    });
                    directionLinesLayer.addLayer(line);
                }
            });
        }

        function updateOutput() {
            const now = new Date();
            const lastUpdate = now.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            activeAlerts.sort((a, b) => b.timestamp - a.timestamp);

            const alertsArrayString = activeAlerts.map(alert => JSON.stringify(alert, null, 4)).join(',\n    ');

            const fullJson = `{
  "last_update": "${lastUpdate} (EET) / ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })} (GMT)",
  "active_alerts": [
    ${alertsArrayString}
  ]
}`;
            document.getElementById('outputJson').value = fullJson;
            
            updateAdminList();
            updateMapDisplay();
        }
        
        function getTypeName(type) {
            const names = {
                s300: 'üöÄ –°-300 / –ë–∞–ª—ñ—Å—Ç–∏–∫–∞', iskander: 'üí• –Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú', kab: 'üí£ –ö–ê–ë / –£–ú–ü–ë', shahed: 'üõ∏ –î—Ä–æ–Ω Shahed',
                fpv: 'üõ∞Ô∏è FPV-–¥—Ä–æ–Ω / –†–æ–∑–≤—ñ–¥–∫–∞', artillery: 'üî• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è / –†–°–ó–í', alert: '‚ö†Ô∏è –ó–∞–≥–∞–ª—å–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞'
            };
            return names[type] || type;
        }

        function getAlertColor(type) {
            const colors = {
                s300: '#e74c3c', iskander: '#f39c12', kab: '#9b59b6', shahed: '#3498db',
                fpv: '#1abc9c', artillery: '#e67e22', alert: '#f1c40f'
            };
            return colors[type] || '#ccc';
        }
        
        // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–ò ---

        function generateNewAlert() {
            const type = document.getElementById('inputType').value;
            const location = document.getElementById('inputLocation').value.trim();
            const coordsStr = document.getElementById('inputCoords').value.trim();
            const message = document.getElementById('inputMessage').value.trim();
            const directionStr = document.getElementById('inputDirection').value.trim();

            if (!location || !coordsStr || !message) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.');
                return;
            }

            const coords = coordsStr.split(',').map(c => parseFloat(c.trim()));
            if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
                alert('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ: —à–∏—Ä–æ—Ç–∞, –¥–æ–≤–≥–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 50.000, 36.250)');
                return;
            }

            let newAlert = {
                type: type,
                location: location.replace(/ /g, '_'),
                coords: coords,
                message: message,
                timestamp: Date.now() 
            };
            
            if (type === 'shahed' && directionStr) {
                try {
                    const parsedDirection = JSON.parse('[' + directionStr + ']');
                    if (Array.isArray(parsedDirection) && parsedDirection.every(arr => Array.isArray(arr) && arr.length === 2)) {
                        newAlert.direction_line = parsedDirection;
                    } else {
                        throw new Error('Invalid format');
                    }
                } catch (e) {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –º–∞—Ä—à—Ä—É—Ç—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: [lat1, lon1], [lat2, lon2]');
                    return;
                }
            }
            
            activeAlerts.unshift(newAlert); 
            
            // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('inputMessage').value = '';
            document.getElementById('inputDirection').value = '';

            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }

            updateOutput();
        }

        function removeAlert(index) {
            activeAlerts.splice(index, 1);
            updateOutput();
        }

        function clearAlerts() {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ –∑–∞–≥—Ä–æ–∑–∏?')) {
                activeAlerts = [];
                updateOutput();
            }
        }

        function updateAdminList() {
            const listDiv = document.getElementById('activeAlertsList');
            if (activeAlerts.length === 0) {
                listDiv.innerHTML = '–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞–≥—Ä–æ–∑.';
                return;
            }
            
            listDiv.innerHTML = activeAlerts.map((alert, index) => {
                const time = new Date(alert.timestamp).toLocaleTimeString('uk-UA');
                return `
                    <div class="alert-item-line" style="border-left-color: ${getAlertColor(alert.type)};">
                        <span style="font-weight: bold;">[${alert.type.toUpperCase()}]</span> 
                        ${time} - ${alert.location.replace(/_/g, ' ')}
                        <button onclick="removeAlert(${index})" style="color: ${getAlertColor(alert.type)};">‚úñ</button>
                    </div>
                `;
            }).join('');
        }
        
        // --- –§–£–ù–ö–¶–ò–ò –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø/–ó–ê–ì–†–£–ó–ö–ò ---

        function loadJson() {
            const jsonText = document.getElementById('outputJson').value.trim();
            document.getElementById('copySuccess').style.display = 'none';

            if (!jsonText) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–≤—Ç–µ JSON-—Ñ–∞–π–ª —É —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–ª–µ.');
                return;
            }
            
            try {
                const data = JSON.parse(jsonText);
                if (data.active_alerts && Array.isArray(data.active_alerts)) {
                    activeAlerts = data.active_alerts;
                    updateOutput();
                    document.getElementById('copySuccess').textContent = `‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${activeAlerts.length} –∑–∞–≥—Ä–æ–∑.`;
                    document.getElementById('copySuccess').className = 'status-message status-success';
                    document.getElementById('copySuccess').style.display = 'block';
                    setTimeout(() => document.getElementById('copySuccess').style.display = 'none', 3000);
                } else {
                    alert('‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –º–∞—Å–∏–≤ "active_alerts".');
                }
            } catch (e) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É JSON. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (–∑–∞–ø—è—Ç—ã–µ, —Å–∫–æ–±–∫–∏).');
                console.error('JSON Parsing Error:', e);
            }
        }

        // --- –§–£–ù–ö–¶–ò–Ø –ê–í–¢–û–ù–û–ú–ù–û–ì–û –°–û–•–†–ê–ù–ï–ù–ò–Ø (–ö—Ä–∏—Ç–∏—á–Ω–æ) ---
        async function saveJsonRemotely() {
            document.getElementById('copySuccess').style.display = 'none';
            const successMsg = document.getElementById('copySuccess');
            
            const outputTextarea = document.getElementById('outputJson');
            const jsonToSave = outputTextarea.value.trim();

            let dataObject;
            try {
                dataObject = JSON.parse(jsonToSave);
            } catch (e) {
                successMsg.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞: JSON –Ω–µ –≤–∞–ª—ñ–¥–Ω–∏–π. –ù–µ–º–æ–∂–ª–∏–≤–æ –∑–±–µ—Ä–µ–≥—Ç–∏.';
                successMsg.className = 'status-message status-error';
                successMsg.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataObject) 
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    successMsg.textContent = '‚úÖ –£–°–ü–Ü–•: –§–∞–π–ª alerts.json –∞–≤—Ç–æ–Ω–æ–º–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!';
                    successMsg.className = 'status-message status-success';
                    successMsg.style.display = 'block';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                } else {
                    successMsg.textContent = `‚ùå –ü–û–ú–ò–õ–ö–ê: –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å Node.js. (${result.message || response.statusText})`;
                    successMsg.className = 'status-message status-error';
                    successMsg.style.display = 'block';
                }
            } catch (error) {
                successMsg.textContent = '‚ùå –ü–û–ú–ò–õ–ö–ê –ú–ï–†–ï–ñ–Ü: –°–µ—Ä–≤–µ—Ä Node.js –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –π–æ–≥–æ!';
                successMsg.className = 'status-message status-error';
                successMsg.style.display = 'block';
                console.error('Network Error:', error);
            }
        }


        // --- –ê–í–¢–û–ó–ê–ü–£–°–ö ---
        document.addEventListener('DOMContentLoaded', initMap);
        document.addEventListener('DOMContentLoaded', updateOutput); 
    </script>
</body>
</html>